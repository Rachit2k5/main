<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart Civic Issue Reporting</title>
<style>
  /* Reset */
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #74ebd5 0%, #ACB6E5 100%);
    margin: 0;
    padding: 20px;
    max-width: 750px;
    margin-left: auto;
    margin-right: auto;
    color: #222;
    line-height: 1.65;
    user-select: none;
  }
  h1, h2 {
    text-align: center;
    color: #2c3e50;
    margin-bottom: 10px;
    text-shadow: 0 1px 3px rgba(0,0,0,0.2);
  }
  form {
    background: #ffffffdd;
    padding: 30px 35px;
    border-radius: 12px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.12);
    border: 2.5px solid #3498db;
    transition: box-shadow 0.35s ease, border-color 0.35s ease;
  }
  form:hover {
    box-shadow: 0 18px 45px rgba(0,0,0,0.18);
    border-color: #2980b9;
  }
  label {
    display: flex;
    flex-direction: column;
    font-weight: 600;
    margin-top: 18px;
    color: #34495e;
    letter-spacing: 0.03em;
  }
  input[type="text"],
  input[type="number"],
  input[type="url"],
  select,
  textarea {
    margin-top: 8px;
    padding: 14px 20px;
    font-size: 1rem;
    font-family: inherit;
    border-radius: 10px;
    border: 2px solid transparent;
    background: #f0f4f7;
    box-shadow: inset 0 2px 6px #cfd9e7;
    transition: all 0.3s ease;
    outline-offset: 2px;
  }
  input[type="text"]:focus,
  input[type="number"]:focus,
  input[type="url"]:focus,
  select:focus,
  textarea:focus {
    background: #fff;
    border-color: #3498db;
    box-shadow: 0 0 12px #3498dbaa;
  }
  textarea {
    resize: vertical;
    min-height: 100px;
  }
  button {
    margin-top: 28px;
    cursor: pointer;
    width: 100%;
    background: #3498db;
    border: none;
    padding: 16px 0;
    font-weight: 700;
    font-size: 1.15rem;
    color: white;
    border-radius: 14px;
    box-shadow: 0 8px 18px rgba(52, 152, 219, 0.55);
    letter-spacing: 0.05em;
    transition: background-color 0.35s ease, box-shadow 0.35s ease, transform 0.2s ease;
    user-select: none;
  }
  button:hover:not(:disabled) {
    background: #2980b9;
    box-shadow: 0 11px 26px rgba(41, 128, 185, 0.75);
    transform: translateY(-3px);
  }
  button:active:not(:disabled) {
    transform: translateY(1px);
  }
  button:disabled {
    background: #95a5a6;
    cursor: default;
    box-shadow: none;
    transform: none;
  }
  #refreshBtn {
    background: #2ecc71;
    margin-bottom: 18px;
    box-shadow: 0 8px 20px rgba(46, 204, 113, 0.75);
    border-radius: 14px;
    padding: 14px 0;
    font-weight: 700;
    font-size: 1.15rem;
    letter-spacing: 0.05em;
    width: 100%;
  }
  #refreshBtn:hover {
    background: #27ae60;
    box-shadow: 0 10px 26px rgba(39, 174, 96, 0.85);
    transform: translateY(-3px);
  }
  hr {
    border: none;
    border-top: 2px solid #dfe6e9;
    margin: 32px 0;
    opacity: 0.72;
  }
  /* Media Controls */
  video, audio {
    display: block;
    width: 100%;
    max-height: 360px;
    border-radius: 16px;
    box-shadow: 0 5px 18px rgba(0,0,0,0.18);
    margin-top: 22px;
    background: #000;
  }
  canvas {
    display: none;
  }
  /* Issues List */
  .issues-list {
    background: #fff;
    border-radius: 18px;
    padding: 28px 32px;
    box-shadow: 0 14px 42px rgba(0, 0, 0, 0.12);
    max-height: 560px;
    overflow-y: auto;
    font-size: 1rem;
    border: 2.3px solid #3498db;
  }
  .issues-list div {
    margin-bottom: 32px;
    padding-bottom: 22px;
    border-bottom: 2px solid #ecf0f1;
    animation: fadeInUp 0.6s ease forwards;
  }
  .issues-list div:last-child {
    border-bottom: none;
    margin-bottom: 8px;
  }
  .issues-list strong {
    font-size: 1.18rem;
    color: #2980b9;
    letter-spacing: 0.04em;
  }
  .issues-list img.issue-photo {
    margin-top: 14px;
    max-width: 230px;
    border-radius: 16px;
    box-shadow: 0 8px 20px rgba(41, 128, 185, 0.35);
    transition: transform 0.3s ease;
    cursor: pointer;
  }
  .issues-list img.issue-photo:hover {
    transform: scale(1.07);
  }
  .issues-list audio {
    margin-top: 14px;
    width: 100%;
    outline: none;
  }
  /* Buttons container */
  #startCameraBtn, #capturePhotoBtn, #startVoiceBtn, #stopVoiceBtn,
  #startVideoBtn, #stopVideoBtn {
    margin-top: 14px;
    width: auto;
    padding: 12px 26px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 1rem;
    user-select: none;
    box-shadow: 0 5px 14px rgba(52, 152, 219, 0.45);
    border: none;
    transition: background-color 0.3s ease, box-shadow 0.3s ease, transform 0.15s ease;
  }
  #startCameraBtn {
    background-color: #3498db;
    color: #fff;
  }
  #startCameraBtn:hover {
    background-color: #2980b9;
    box-shadow: 0 7px 18px rgba(41, 128, 185, 0.65);
    transform: translateY(-2px);
  }
  #capturePhotoBtn {
    background-color: #27ae60;
    color: #fff;
  }
  #capturePhotoBtn:hover {
    background-color: #219150;
    box-shadow: 0 7px 18px rgba(33, 145, 80, 0.65);
    transform: translateY(-2px);
  }
  #startVoiceBtn {
    background-color: #9b59b6;
    color: #fff;
  }
  #startVoiceBtn:hover {
    background-color: #7d3c98;
    box-shadow: 0 7px 18px rgba(125, 60, 152, 0.65);
    transform: translateY(-2px);
  }
  #stopVoiceBtn {
    background-color: #c0392b;
    color: #fff;
  }
  #stopVoiceBtn:hover:not(:disabled) {
    background-color: #922b21;
    box-shadow: 0 7px 18px rgba(146, 43, 33, 0.65);
    transform: translateY(-2px);
  }
  #stopVoiceBtn:disabled {
    background-color: #7f8c8d;
    box-shadow: none;
    cursor: default;
    transform: none;
  }
  #startVideoBtn {
    background-color: #e67e22;
    color: #fff;
  }
  #startVideoBtn:hover {
    background-color: #d35400;
    box-shadow: 0 7px 18px rgba(211, 84, 0, 0.65);
    transform: translateY(-2px);
  }
  #stopVideoBtn {
    background-color: #d35400;
    color: #fff;
  }
  #stopVideoBtn:hover:not(:disabled) {
    background-color: #b84300;
    box-shadow: 0 7px 18px rgba(184, 67, 0, 0.65);
    transform: translateY(-2px);
  }
  #stopVideoBtn:disabled {
    background-color: #7f8c8d;
    box-shadow: none;
    cursor: default;
    transform: none;
  }
  /* Responsive tweaks */
  @media (max-width: 640px) {
    body {
      padding: 15px 12px;
      max-width: 100%;
    }
    form {
      padding: 22px 26px;
    }
    button, select, input, textarea {
      font-size: 1rem;
      padding: 12px 16px;
    }
    .issues-list img.issue-photo {
      max-width: 100%;
    }
  }
  /* Animations */
  @keyframes fadeInUp {
    0% {
      opacity: 0;
      transform: translateY(25px);
    }
    100% {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>
</head>
<body>
<h1>Report a Civic Issue</h1>
<form id="issueForm">
  <label>Category:
    <select name="category" required>
      <option value="pothole">Pothole</option>
      <option value="streetlight">Streetlight</option>
      <option value="garbage">Garbage</option>
      <option value="water">Water</option>
      <option value="others">Others</option>
    </select>
  </label>
  <label>Description:
    <textarea name="description" rows="3" required></textarea>
  </label>
  <label>Latitude:
    <input type="number" step="any" name="latitude" required />
  </label>
  <label>Longitude:
    <input type="number" step="any" name="longitude" required />
  </label>
  <button type="button" id="locateBtn">Use My Current Location</button>
  <hr />
  <label>Photo:
    <input type="file" accept="image/*" capture="environment" name="photo" />
  </label>
  <video id="photoVideo" autoplay muted playsinline style="display:none;"></video>
  <button type="button" id="startCameraBtn">Start Photo Camera</button>
  <button type="button" id="capturePhotoBtn" style="display:none;">Capture Photo</button>
  <canvas id="canvas" style="display:none;"></canvas>
  <hr />
  <label>Video:
    <input type="file" accept="video/*" capture="environment" name="videoFile" />
  </label>
  <video id="videoRecording" controls style="display:none; margin-top:10px;"></video>
  <button type="button" id="startVideoBtn">Start Video Recording</button>
  <button type="button" id="stopVideoBtn" disabled>Stop Video Recording</button>
  <hr />
  <label>Voice Recording:</label>
  <button type="button" id="startVoiceBtn">Start Recording</button>
  <button type="button" id="stopVoiceBtn" disabled>Stop Recording</button>
  <audio id="audioPlayback" controls style="display:none;"></audio>
  <hr />
  <button type="submit">Report Issue</button>
</form>
<h2>Reported Issues</h2>
<button id="refreshBtn">Refresh List</button>
<div class="issues-list" id="issuesList"></div>

<script>
  const form = document.getElementById('issueForm');
  const issuesList = document.getElementById('issuesList');

  // Location detection
  const latitudeInput = form.elements['latitude'];
  const longitudeInput = form.elements['longitude'];
  document.getElementById('locateBtn').onclick = () => {
    if (!navigator.geolocation) {
      alert('Geolocation not supported by your browser.');
      return;
    }
    navigator.geolocation.getCurrentPosition(position => {
      latitudeInput.value = position.coords.latitude.toFixed(6);
      longitudeInput.value = position.coords.longitude.toFixed(6);
    }, () => alert('Unable to retrieve your location.'));
  };

  // Photo camera setup
  const photoVideo = document.getElementById('photoVideo');
  const startCameraBtn = document.getElementById('startCameraBtn');
  const capturePhotoBtn = document.getElementById('capturePhotoBtn');
  const canvas = document.getElementById('canvas');
  let cameraStream = null;
  let capturedPhotoBlob = null;

  startCameraBtn.onclick = async () => {
    try {
      cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }});
      photoVideo.srcObject = cameraStream;
      photoVideo.style.display = 'block';
      capturePhotoBtn.style.display = 'inline-block';
      startCameraBtn.style.display = 'none';
    } catch(e) {
      alert('Could not access camera.');
    }
  };

  capturePhotoBtn.onclick = () => {
    canvas.width = photoVideo.videoWidth;
    canvas.height = photoVideo.videoHeight;
    canvas.getContext('2d').drawImage(photoVideo, 0, 0);
    canvas.toBlob(blob => {
      capturedPhotoBlob = blob;
      alert('Photo captured! You can now submit the form.');
    }, "image/jpeg");
    photoVideo.style.display = 'none';
    capturePhotoBtn.style.display = 'none';
    if (cameraStream) {
      cameraStream.getTracks().forEach(track => track.stop());
      cameraStream = null;
    }
    startCameraBtn.style.display = 'inline-block';
  };

  // Video recording setup
  const startVideoBtn = document.getElementById('startVideoBtn');
  const stopVideoBtn = document.getElementById('stopVideoBtn');
  const videoRecording = document.getElementById('videoRecording');
  let videoStream = null;
  let mediaRecorderVideo = null;
  let recordedVideoChunks = [];
  let recordedVideoBlob = null;

  startVideoBtn.onclick = async () => {
    try {
      videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
      mediaRecorderVideo = new MediaRecorder(videoStream);
      recordedVideoChunks = [];

      mediaRecorderVideo.ondataavailable = e => {
        if (e.data.size > 0) recordedVideoChunks.push(e.data);
      };

      mediaRecorderVideo.onstop = () => {
        recordedVideoBlob = new Blob(recordedVideoChunks, { type: 'video/webm' });
        videoRecording.src = URL.createObjectURL(recordedVideoBlob);
        videoRecording.style.display = 'block';
        if (videoStream) {
          videoStream.getTracks().forEach(track => track.stop());
          videoStream = null;
        }
      };

      mediaRecorderVideo.start();
      startVideoBtn.disabled = true;
      stopVideoBtn.disabled = false;
    } catch(e) {
      alert('Could not start video recording.');
    }
  };

  stopVideoBtn.onclick = () => {
    if (mediaRecorderVideo && mediaRecorderVideo.state === 'recording') {
      mediaRecorderVideo.stop();
      startVideoBtn.disabled = false;
      stopVideoBtn.disabled = true;
    }
  };

  // Voice recording
  const startVoiceBtn = document.getElementById('startVoiceBtn');
  const stopVoiceBtn = document.getElementById('stopVoiceBtn');
  const audioPlayback = document.getElementById('audioPlayback');
  let mediaRecorderAudio;
  let audioChunks = [];
  let recordedAudioBlob = null;

  startVoiceBtn.onclick = async () => {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert('Audio recording not supported in your browser.');
      return;
    }
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorderAudio = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorderAudio.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorderAudio.onstop = () => {
        recordedAudioBlob = new Blob(audioChunks, { type: 'audio/webm' });
        audioPlayback.src = URL.createObjectURL(recordedAudioBlob);
        audioPlayback.style.display = 'block';
      };
      mediaRecorderAudio.start();
      startVoiceBtn.disabled = true;
      stopVoiceBtn.disabled = false;
    } catch(e) {
      alert('Could not start audio recording.');
    }
  };

  stopVoiceBtn.onclick = () => {
    if (mediaRecorderAudio && mediaRecorderAudio.state === 'recording') {
      mediaRecorderAudio.stop();
      startVoiceBtn.disabled = false;
      stopVoiceBtn.disabled = true;
    }
  };

  // Form submission
  form.onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData();

    // Append text inputs
    formData.append('category', form.elements['category'].value);
    formData.append('description', form.elements['description'].value);
    formData.append('latitude', form.elements['latitude'].value);
    formData.append('longitude', form.elements['longitude'].value);

    // Append photo
    if (capturedPhotoBlob) {
      formData.append('photo', capturedPhotoBlob, 'captured_photo.jpg');
    } else if (form.elements['photo'].files.length > 0) {
      formData.append('photo', form.elements['photo'].files[0]);
    }

    // Append audio
    if (recordedAudioBlob) {
      formData.append('audio', recordedAudioBlob, 'recording.webm');
    }

    // Append video from recording or uploaded file
    if (recordedVideoBlob) {
      formData.append('video', recordedVideoBlob, 'recorded_video.webm');
    } else if (form.elements['videoFile'].files.length > 0) {
      formData.append('video', form.elements['videoFile'].files[0]);
    }

    try {
      const res = await fetch('/issues', {
        method: 'POST',
        body: formData,
      });
      if (!res.ok) {
        alert('Failed to report issue.');
        return;
      }
      alert('Issue reported successfully!');
      form.reset();
      capturedPhotoBlob = null;
      recordedAudioBlob = null;
      recordedVideoBlob = null;
      audioPlayback.style.display = 'none';
      videoRecording.style.display = 'none';
      loadIssues();
    } catch {
      alert('Error submitting form.');
    }
  };

  // Load issues and display
  async function loadIssues() {
    const res = await fetch('/issues');
    const issues = await res.json();
    if (!issues.length) {
      issuesList.innerHTML = '<p>No issues reported yet.</p>';
      return;
    }
    issuesList.innerHTML = issues.map(issue => `
      <div>
        <strong>${issue.category}</strong> - ${issue.description}<br />
        Location: (${issue.latitude.toFixed(6)}, ${issue.longitude.toFixed(6)})<br />
        Status: ${issue.status}<br />
        Created at: ${new Date(issue.created_at).toLocaleString()}<br />
        Updated at: ${new Date(issue.updated_at).toLocaleString()}<br />
        ${issue.photo_url ? `<img class="issue-photo" src="${issue.photo_url}" alt="Photo" />` : ''}
        ${issue.audio_url ? `<audio controls src="${issue.audio_url}"></audio>` : ''}
        ${issue.video_url ? `<video controls src="${issue.video_url}" style="max-width:230px; border-radius:16px; box-shadow:0 8px 20px rgba(41, 128, 185, 0.35); margin-top:14px;"></video>` : ''}
        <hr />
      </div>
    `).join('');
  }

  document.getElementById('refreshBtn').onclick = loadIssues;

  // Load on page load
  loadIssues();
</script>
</body>
</html>
