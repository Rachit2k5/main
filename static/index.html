<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart Civic Issue Reporting</title>
<link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<style>
:root {
  --primary: #1976D2;
  --primary-dark: #1456a0;
  --accent: #29B6F6;
  --success: #44b953;
  --warning: #ffd602;
  --background: #f7fafc;
  --card: #fff;
  --radius: 17px;
  --shadow: 0 6px 24px 0px rgba(27,60,107,0.13),0 2px 4px rgba(27,60,107,0.06);
  --input-border: #dce4ec;
}
* { box-sizing: border-box; }
body {
  font-family: 'Roboto', Arial, sans-serif;
  background: linear-gradient(135deg, #7ed6df 0%, #b2bec3 100%) fixed;
  margin: 0;
  min-height: 100vh;
  color: #1c2833;
}
.header-hero {
  background: linear-gradient(94deg, var(--primary) 64%, var(--accent) 100%);
  color: white;
  text-align: left;
  padding: 38px 18px 22px 18px;
  border-bottom-left-radius: var(--radius);
  border-bottom-right-radius: var(--radius);
  box-shadow: 0 10px 44px 0px rgba(33,150,243,0.13);
  margin-bottom: 2.4em;
  display: flex;
  align-items: center;
  gap: 30px;
}
.header-hero .material-icons {
  font-size: 54px;
  background: #fff3;
  border-radius: 50%;
  padding: 11px;
  margin-right: 5px;
  box-shadow: 0 6px 14px #1976d232;
}
.header-hero-content h1 {
  font-size: 2.2rem;
  margin: 0;
  font-weight: 700;
  text-shadow: 0 2px 12px #00000018;
}
.header-hero-content h2 {
  font-size: 1.07rem;
  font-weight: 400;
  margin: 8px 0 0 0;
  opacity: 0.99;
  letter-spacing: 0.012em;
}

form {
  background: var(--card);
  max-width: 500px;
  margin: 27px auto 44px auto;
  padding: 36px 30px 30px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 2px solid var(--primary);
  display: flex;
  flex-direction: column;
  gap: 20px;
  transition: box-shadow 0.32s, border-color 0.31s;
}
form label {
  font-weight: 500;
  margin-bottom: 0.2em;
  color: #155dae;
  font-size:1.07em;
  display:block;
}
input,select,textarea,button{font-family:inherit;}
input[type="text"],input[type="email"],input[type="number"],select,textarea {
  margin-top: 8px;
  padding: 11px 14px;
  font-size: 1em;
  border-radius: 9px;
  border: 1.7px solid var(--input-border);
  background: var(--background);
  width: 100%;
  margin-bottom:1px;
  outline: none;
  transition: border-color .23s, box-shadow 0.17s;
  box-shadow:0 1px 2px #b2bec334;
}
input:focus,select:focus,textarea:focus{border-color:var(--accent);background:#fff;box-shadow:0 2px 8px #29b6f633;}
textarea{min-height: 75px;resize:vertical;}
button[type="submit"]{
  background: linear-gradient(97deg,var(--accent) 70%,var(--primary));
  color: #fff;
  padding:14px 0;
  font-weight:900;letter-spacing:0.02em;
  font-size:1.1rem;
  border-radius: 10px;
  margin-top: 10px;
  box-shadow:0 7px 20px #1976d217;
  border:none;cursor:pointer;
  transition: background 0.19s, box-shadow 0.21s;
}
button[type="submit"]:hover{background:var(--primary-dark);}
button, #refreshBtn {
  font-weight:700;
  box-shadow:0 4px 14px #1976d219;
}

hr { border: none; border-top: 2px solid #e4e9ec; opacity:0.65; margin:19px 0; }
#refreshBtn {
  margin: 10px auto 5px;
  background: linear-gradient(98deg,var(--accent),var(--primary) 80%);
  border-radius: 9px; font-size:.99rem;
  padding:10px 29px; font-weight:800;color:#fff;
  border:none; transition:background 0.17s;
}
#refreshBtn:hover{ background:linear-gradient(98deg,#1976d2 60%,#29b6f6 100%);}
.issues-list {
  background: var(--card);
  border-radius:16px;
  max-width: 700px;
  margin:3em auto 45px auto;
  padding:25px 23px 12px 23px;
  box-shadow:var(--shadow);font-size:1.08em;border:2px solid var(--primary);
}
.issues-list .card {
  border-bottom: 2px solid #e7ecf4;
  margin-bottom: 33px;
  padding-bottom: 23px;
  border-radius:11px;
  box-shadow:0 1px 12px #1976d210;
  padding-left:5px;padding-right:5px;
  background: #f4fafd;
  position:relative;
  transition:box-shadow 0.21s;
}
.issues-list .card:last-child{border-bottom:none;margin-bottom:0;}
.issues-list .category { color:var(--primary);font-weight:700;letter-spacing:0.03em;font-size:1.11rem;}
.issues-list .status-tag {
  display:inline-block;
  padding: 3.4px 13px;
  border-radius:12px;
  font-weight:700;
  font-size:0.93rem;
  margin-left:13px;
  background:#ddd; color:#222;
  text-transform:capitalize;
  vertical-align:middle;
}
.issues-list .status-tag.reported { background:#e65100;color:#fff;}
.issues-list .status-tag.acknowledged{background:var(--primary);color:#fff;}
.issues-list .status-tag.inprogress{background:var(--warning);color:#222;}
.issues-list .status-tag.resolved{background:var(--success);}
.issues-list .meta { color:#555b; font-size:0.89em;margin:8px 0;}
.issues-list img.issue-photo,
.issues-list video,
.issues-list audio, .issues-list img.user-avatar {
  margin-top:12px;max-width:240px;
  border-radius:var(--radius);
  box-shadow:0 6px 16px #1976d229;
  display:block;
  transition: box-shadow .22s, transform .22s;
}
.issues-list img.issue-photo:hover{box-shadow:0 8px 16px #29b6f650;transform:scale(1.04);}
.issues-list .user-info {
  display:flex;align-items:center;gap:11px;
  margin-top:8px;margin-bottom:7px;}
.issues-list .user-info img.user-avatar{
  width:34px;height:34px;border-radius:50%;border:2px solid var(--primary-dark);box-shadow:0 1px 7px #16385d30;
}
.issues-list .user-info .userName { font-size:1em;font-weight:700;color:#1360a3;}
/* Responsiveness */
@media (max-width:900px){
  .issues-list,form{padding: 7vw 3vw;max-width:99vw;border-radius:var(--radius);}
}
@media (max-width:600px){
  .header-hero{padding:19px 4vw;gap:15px;font-size:.96em;}
  .header-hero .material-icons{font-size:38px;}
  form{padding:14px 4vw;}
  .issues-list{padding:9px 1vw;}
}
</style>
</head>
<body>
<div class="header-hero">
  <span class="material-icons" style="background:#fff2;color:var(--primary-dark);">location_city</span>
  <div class="header-hero-content">
    <h1>Smart Civic Issue Reporting</h1>
    <h2>Empowering Citizens ⬩ Cleaner, Safer Cities ⬩ Digital Social Change</h2>
  </div>
</div>

<!-- Report Form (always visible) -->
<form id="issueForm" autocomplete="off">
  <label>Name:
    <input type="text" name="user_name" placeholder="Your name" required>
  </label>
  <label>Email:
    <input type="email" name="user_email" placeholder="Your email" required>
  </label>
  <label>Avatar (Photo URL or Upload):
    <input type="url" name="user_avatar" placeholder="Paste photo URL (optional)">
    <span style="display:block;margin:0.3em 0 0.3em 0;">OR</span>
    <input type="file" accept="image/*" name="avatarUpload" style="font-size:0.94em;">
  </label>
  <hr>
  <label>Category:
    <select name="category" required>
      <option value="pothole">Pothole</option>
      <option value="streetlight">Streetlight</option>
      <option value="garbage">Garbage</option>
      <option value="water">Water Leakage</option>
      <option value="others">Others</option>
    </select>
  </label>
  <label>Description:
    <textarea name="description" rows="3" required placeholder="Describe the civic issue..."></textarea>
  </label>
  <div style="display:flex; gap:10px;">
    <label style="flex:1">Latitude:
      <input type="number" step="any" name="latitude" required />
    </label>
    <label style="flex:1">Longitude:
      <input type="number" step="any" name="longitude" required />
    </label>
    <button type="button" id="locateBtn" style="margin-top:auto;height:38px;align-self:end;background:var(--accent);border-radius:8px;color:#fff;font-weight:700;">
      <span class="material-icons" style="font-size:17px;vertical-align:middle;">my_location</span>
    </button>
  </div>
  <hr/>
  <label>Photo:
    <input type="file" accept="image/*" capture="environment" name="photo"/>
  </label>
  <video id="photoVideo" autoplay muted playsinline style="display:none;"></video>
  <div style="display:flex;gap:.6em;">
    <button type="button" id="startCameraBtn">Start Camera</button>
    <button type="button" id="capturePhotoBtn" style="display:none;">Capture Photo</button>
  </div>
  <canvas id="canvas" style="display:none;"></canvas>
  <hr />
  <label>Video:
    <input type="file" accept="video/*" capture="environment" name="video"/>
  </label>
  <video id="videoRecording" controls style="display:none; margin-top:10px;"></video>
  <div style="display:flex;gap:.6em;">
    <button type="button" id="startVideoBtn">Start Video Recording</button>
    <button type="button" id="stopVideoBtn" disabled>Stop Video Recording</button>
  </div>
  <hr />
  <label>Voice Recording:</label>
  <div style="display:flex;gap:.6em;">
    <button type="button" id="startVoiceBtn">Start Recording</button>
    <button type="button" id="stopVoiceBtn" disabled>Stop Recording</button>
  </div>
  <audio id="audioPlayback" controls style="display:none;"></audio>
  <hr />
  <button type="submit"><span class="material-icons" style="vertical-align:middle;margin-right:8px;">send</span>Report Issue</button>
</form>

<h2 style="margin-bottom:0;border-bottom:3px solid #1976d2;width:fit-content;padding-bottom:10px;margin-left:auto;margin-right:auto;border-radius:7px;font-size:1.15em;">Reported Issues</h2>
<button id="refreshBtn"><span class="material-icons" style="vertical-align:middle;margin-right:7px;">refresh</span>Refresh List</button>
<div class="issues-list" id="issuesList"></div>

<script>
// Geo location support (unchanged)
const form = document.getElementById('issueForm');
const issuesList = document.getElementById('issuesList');
const latitudeInput = form.elements['latitude'];
const longitudeInput = form.elements['longitude'];
document.getElementById('locateBtn').onclick = () => {
  if (!navigator.geolocation) {
    alert('Geolocation not supported by your browser.');
    return;
  }
  navigator.geolocation.getCurrentPosition(position => {
    latitudeInput.value = position.coords.latitude.toFixed(6);
    longitudeInput.value = position.coords.longitude.toFixed(6);
  }, () => alert('Unable to retrieve your location.'));
};

// If user uploads avatar file, temporarily display as local URL and submit
let userAvatarUrl = '';
form.elements['avatarUpload'].addEventListener('change', e => {
  const file = e.target.files[0];
  if (file) {
    // Show preview (optional)
    userAvatarUrl = URL.createObjectURL(file);
    // Optionally use this local URL for display preview here
    // In POST, the image will be sent as form-data field 'avatarUpload'
  } else {
    userAvatarUrl = '';
  }
});

// FORM SUBMISSION
form.onsubmit = async (e) => {
  e.preventDefault();
  const formData = new FormData(form);
  // 1. Prefer uploaded file as avatar, else use url, else none
  let avatarValue = '';
  if (form.elements['avatarUpload'].files.length > 0) {
    avatarValue = ''; // Will send file as 'avatarUpload'
  } else {
    avatarValue = form.elements['user_avatar'].value;
    formData.set('user_avatar', avatarValue);  // Use user-entered url if file not present
  }
  // If backend expects 'user_avatar' to be a file, remove value and only upload file.

  try {
    const res = await fetch('/issues', { method: 'POST', body: formData });
    if (!res.ok) throw new Error();
    alert('Issue reported successfully!');
    form.reset();
    loadIssues();
  } catch {
    alert('Error submitting form.');
  }
};

// ---- Issues Rendering ----
async function loadIssues() {
  const res = await fetch('/issues');
  const issues = await res.json();
  if (!issues.length){
    issuesList.innerHTML = '<p style="text-align:center;color:#555;">No issues reported yet.</p>';
    return;
  }
  issuesList.innerHTML = issues.map(issue => `
    <div class="card">
      <div class="category">${issue.category}
        <span class="status-tag ${issue.status.replace('_','').toLowerCase()}">${issue.status.replace('_',' ')}</span>
      </div>
      <div class="meta">🕑 <strong>Created:</strong> ${new Date(issue.created_at).toLocaleString()}</div>
      <div style="margin-bottom:6px;word-break:break-word;"><span style="font-weight:500;">${issue.description}</span></div>
      <div class="meta"><i class="material-icons" style="font-size:16px;vertical-align:middle;">place</i>
        <span style="color:#1b3d6b"><b>${Number(issue.latitude).toFixed(6)}, ${Number(issue.longitude).toFixed(6)}</b></span>
      </div>
      ${(issue.user_avatar || issue.user_name || issue.user_email) ? `
      <div class="user-info">
        ${issue.user_avatar ? `<img class="user-avatar" src="${issue.user_avatar}" alt="user"/>` : ''}
        <span class="userName">${issue.user_name || issue.user_email || "No Name"}</span>
      </div>
      ` : ''}
      ${issue.photo_filename ? `<img class="issue-photo" src="/static/uploads/${issue.photo_filename}" alt="Photo" />` : ''}
      ${issue.audio_filename ? `<audio controls src="/static/uploads/${issue.audio_filename}"></audio>` : ''}
      ${issue.video_filename ? `<video controls src="/static/uploads/${issue.video_filename}"></video>` : ''}
      <div class="meta"><b>Updated:</b> ${new Date(issue.updated_at).toLocaleString()}</div>
    </div>
  `).join('');
}
document.getElementById('refreshBtn').onclick = loadIssues;
loadIssues();
</script>
</body>
</html>
