<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart Civic Issue Reporting</title>
<style>
/* ... [Your existing CSS unchanged; omitted for brevity] ... */
</style>
</head>
<body>
<!-- === Google Login Bar (NEW) === -->
<div id="googleAuthBar" style="display: flex; align-items: center; justify-content: flex-end; margin-bottom: 25px;">
  <div id="userBar" style="display:none;">
    <img id="userAvatar" src="" alt="Avatar" style="width:44px;height:44px;border-radius:50%;margin-right:10px;">
    <span id="userName" style="font-weight:600;margin-right:12px;"></span>
    <button id="logoutBtn" style="background:#ccc;padding:7px 13px;border-radius:8px;box-shadow:none;border:1px solid #888;font-weight:700;cursor:pointer;">Logout</button>
  </div>
  <button id="loginBtn" style="background:#4285F4;color:white;padding:10px 18px;border:none;border-radius:8px;font-size:1rem;">Sign in with Google</button>
</div>
<!-- === End Google Login Bar === -->

<h1>Report a Civic Issue</h1>
<form id="issueForm">
  <label>Category:
    <select name="category" required>
      <option value="pothole">Pothole</option>
      <option value="streetlight">Streetlight</option>
      <option value="garbage">Garbage</option>
      <option value="water">Water</option>
      <option value="others">Others</option>
    </select>
  </label>
  <label>Description:
    <textarea name="description" rows="3" required></textarea>
  </label>
  <label>Latitude:
    <input type="number" step="any" name="latitude" required />
  </label>
  <label>Longitude:
    <input type="number" step="any" name="longitude" required />
  </label>
  <button type="button" id="locateBtn">Use My Current Location</button>
  <hr />
  <label>Photo:
    <input type="file" accept="image/*" capture="environment" name="photo" />
  </label>
  <video id="photoVideo" autoplay muted playsinline style="display:none;"></video>
  <button type="button" id="startCameraBtn">Start Photo Camera</button>
  <button type="button" id="capturePhotoBtn" style="display:none;">Capture Photo</button>
  <canvas id="canvas" style="display:none;"></canvas>
  <hr />
  <label>Video:
    <input type="file" accept="video/*" capture="environment" name="videoFile" />
  </label>
  <video id="videoRecording" controls style="display:none; margin-top:10px;"></video>
  <button type="button" id="startVideoBtn">Start Video Recording</button>
  <button type="button" id="stopVideoBtn" disabled>Stop Video Recording</button>
  <hr />
  <label>Voice Recording:</label>
  <button type="button" id="startVoiceBtn">Start Recording</button>
  <button type="button" id="stopVoiceBtn" disabled>Stop Recording</button>
  <audio id="audioPlayback" controls style="display:none;"></audio>
  <hr />
  <button type="submit">Report Issue</button>
</form>
<h2>Reported Issues</h2>
<button id="refreshBtn">Refresh List</button>
<div class="issues-list" id="issuesList"></div>

<!-- Google One Tap & Login Script (NEW) -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<script>
// ===== Google Login Logic =====
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const userBar = document.getElementById('userBar');
const userAvatar = document.getElementById('userAvatar');
const userNameSpan = document.getElementById('userName');
let googleUser = null;

// Google OAuth login handshake (redirect to backend for auth)
loginBtn.onclick = () => {
  fetch('/auth/google/login').then(res => res.json()).then(data => {
    window.location.href = data.auth_url;
  });
};

// On return from Google, extract info from backend
function tryRestoreGoogleUser() {
  if (window.location.pathname === "/auth/google/callback" && window.location.search.includes("code=")) {
    fetch('/auth/google/callback' + window.location.search)
      .then(res => res.json())
      .then(user => {
        googleUser = user;
        showUserBar(user);
        window.history.replaceState({}, document.title, "/");
      });
  }
}
function showUserBar(user) {
  userBar.style.display = 'flex';
  loginBtn.style.display = 'none';
  userAvatar.src = user.picture;
  userNameSpan.textContent = user.name || user.email || "User";
}
logoutBtn.onclick = () => {
  googleUser = null;
  userBar.style.display = 'none';
  loginBtn.style.display = 'inline-block';
};
tryRestoreGoogleUser();

// ====== Your Existing JS Remains Unchanged Below (location, camera, media, form) =====
const form = document.getElementById('issueForm');
const issuesList = document.getElementById('issuesList');
// ... [All your other code unchanged; can remain as is, but update form submission as below]

// ----- In your form submission, add user info if logged in -----
form.onsubmit = async (e) => {
  e.preventDefault();
  const formData = new FormData();

  // Append text inputs
  formData.append('category', form.elements['category'].value);
  formData.append('description', form.elements['description'].value);
  formData.append('latitude', form.elements['latitude'].value);
  formData.append('longitude', form.elements['longitude'].value);

  // Append photo
  if (capturedPhotoBlob) {
    formData.append('photo', capturedPhotoBlob, 'captured_photo.jpg');
  } else if (form.elements['photo'].files.length > 0) {
    formData.append('photo', form.elements['photo'].files[0]);
  }

  // Append audio
  if (recordedAudioBlob) {
    formData.append('audio', recordedAudioBlob, 'recording.webm');
  }

  // Append video from recording or uploaded file
  if (recordedVideoBlob) {
    formData.append('video', recordedVideoBlob, 'recorded_video.webm');
  } else if (form.elements['videoFile'].files.length > 0) {
    formData.append('video', form.elements['videoFile'].files[0]);
  }

  // === NEW: Attach Google user data if logged in ===
  if (googleUser) {
    formData.append('user_name', googleUser.name || '');
    formData.append('user_email', googleUser.email || '');
    formData.append('user_avatar', googleUser.picture || '');
  }

  try {
    const res = await fetch('/issues', {
      method: 'POST',
      body: formData,
    });
    if (!res.ok) {
      alert('Failed to report issue.');
      return;
    }
    alert('Issue reported successfully!');
    form.reset();
    capturedPhotoBlob = null;
    recordedAudioBlob = null;
    recordedVideoBlob = null;
    audioPlayback.style.display = 'none';
    videoRecording.style.display = 'none';
    loadIssues();
  } catch {
    alert('Error submitting form.');
  }
};

// --------- All your existing location/media UI JS can remain unchanged ----------

// ... [Rest of your JavaScript code as previously written]
</script>
</body>
</html>
const userBar = document.getElementById('userBar');
const userAvatar = document.getElementById('userAvatar');
const userNameSpan = document.getElementById('userName');
let googleUser = null;

// Handle Login: Redirect user to backend's /auth/google/login for OAuth
loginBtn.onclick = () => {
  fetch('/auth/google/login')
    .then(res => res.json())
    .then(data => {
      window.location.href = data.auth_url; // Google login page
    });
};

// After redirect back from Google, get user info from backend
function tryRestoreGoogleUser() {
  if (window.location.pathname === "/auth/google/callback" && window.location.search.includes("code=")) {
    fetch('/auth/google/callback' + window.location.search)
      .then(res => res.json())
      .then(user => {
        googleUser = user;
        showUserBar(user);
        // Clean URL so ?code=... disappears after login
        window.history.replaceState({}, document.title, "/");
      });
  }
}

// Update UI for logged-in user
function showUserBar(user) {
  userBar.style.display = 'flex';
  loginBtn.style.display = 'none';
  userAvatar.src = user.picture;
  userNameSpan.textContent = user.name || user.email || "User";
}

// Logout: Hide bar, show login button
logoutBtn.onclick = () => {
  googleUser = null;
  userBar.style.display = 'none';
  loginBtn.style.display = 'inline-block';
  // Optional: Clear any localStorage/session data here
};

// On page load, check if coming from Google
tryRestoreGoogleUser();


</script>
</body>
</html>
