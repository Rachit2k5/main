<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart Civic Issue Reporting</title>

<!-- Google Fonts & Material Icons -->
<link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<style>
:root {
  --primary: #1976D2;
  --primary-dark: #0D47A1;
  --accent: #29B6F6;
  --light-bg: #f2f6fb;
  --card-bg: #fff;
  --status-reported: #e65100;
  --status-acknowledged: #196fad;
  --status-inprogress: #fbc02d;
  --status-resolved: #388e3c;
  --radius: 17px;
  --shadow: 0 6px 32px 0px rgba(27,60,107,0.13),0 2px 4px rgba(27,60,107,0.06);
}
body {
  font-family: 'Roboto', Arial, sans-serif;
  background: linear-gradient(135deg, #7ed6df 0%, #b2bec3 100%) fixed;
  min-height: 100vh;
  margin: 0;
  padding: 0;
  color: #22313f;
}
.header-hero {
  background: linear-gradient(96deg, #1976d2 60%, #29b6f6 100%);
  color: white;
  text-align: left;
  padding: 38px 24px 22px 24px;
  border-bottom-left-radius: var(--radius);
  border-bottom-right-radius: var(--radius);
  box-shadow: 0 15px 54px 0px rgba(33,150,243,0.22);
  margin-bottom: 2em;
  display: flex;
  align-items: center;
  gap: 30px;
  min-height: 100px;
}
.header-hero .material-icons {
  font-size: 52px;
  background: #fff3;
  border-radius: 50%;
  padding: 10px;
  margin-right: 10px;
  box-shadow: 0 6px 14px #1976d235;
  transition: background .28s, box-shadow 0.28s;
}
.header-hero-content {
  display: flex;
  flex-direction: column;
  gap: 5px;
}
.header-hero h1 {
  font-size: 2.65rem;
  letter-spacing: .01em;
  margin: 0;
  font-weight: 700;
  text-shadow: 0 3px 16px #0002;
}
.header-hero h2 {
  font-size: 1.13rem;
  font-weight: 400;
  margin: 7px 0 0 0;
  opacity: 0.97;
  letter-spacing: 0.015em;
}
#googleAuthBar {
  display: flex; 
  align-items: center; 
  justify-content: flex-end;
  margin-top: 14px;
  margin-bottom: 18px; 
  gap: 12px;
}
#userBar { display:none; align-items: center; }
#userAvatar { border-radius:50%; width: 46px; height: 46px; border:3px solid var(--primary); box-shadow:0 1px 8px #2223; margin-right:8px;}
#userName { font-weight:600; margin-right:12px; font-size: 1.06rem;}
#logoutBtn, #loginBtn {
  background: var(--primary);
  color: #fff;
  font-weight: 700;
  padding: 8px 22px;
  border-radius: 7px;
  border: none;
  box-shadow: 0 2px 10px #2222;
  font-size: 1rem;
  margin-left: 10px;
  cursor: pointer;
  transition: background 0.19s, box-shadow 0.19s, color 0.17s;
}
#logoutBtn { background: #bbb; color:#233; }
#loginBtn:hover, #logoutBtn:hover { background: var(--primary-dark); color:#fff; box-shadow: 0 3px 18px #1976d233; }

form {
  background: var(--card-bg);
  max-width: 530px;
  margin: 22px auto 32px auto;
  padding: 38px 35px 32px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  border: 2.5px solid var(--primary);
  transition: box-shadow 0.34s, border-color 0.34s;
  display: flex; 
  flex-direction: column;
  gap: 18px;
}
form label {
  font-weight: 500;
  display: block;
  margin-top: 0;
  margin-bottom: 0;
}
input, select, textarea, button {
  font-family: inherit;
}
input[type="text"],
input[type="number"],
select,
textarea {
  margin-top: 8px;
  padding: 13px 16px;
  font-size: 0.99rem;
  border-radius: 10px;
  border: 2px solid #dfe3ee;
  background: var(--light-bg);
  width: 100%;
  transition: border-color .24s, box-shadow 0.19s;
  margin-bottom: 1px;
  outline: none;
  box-shadow:0 1px 3px #b2bec370;
}
input:focus, select:focus, textarea:focus { border-color: var(--accent); background:#fff; box-shadow: 0 2px 9px #29b6f644; }
textarea { min-height: 85px; resize: vertical; }
button[type="submit"] {
  background: linear-gradient(97deg,var(--accent) 70%,var(--primary));
  font-weight: 900;
  letter-spacing: 0.03em;
  font-size: 1.1rem;
  color: #fff;
  padding: 18px 0;
  border-radius: 13px;
  margin-top: 14px;
  margin-bottom: 0;
  box-shadow: 0 8px 26px rgba(30,116,218, .15);
  border: none;
  cursor: pointer;
  transition: background 0.18s, box-shadow 0.28s;
}
button[type="submit"]:hover { background: var(--primary-dark); box-shadow:0 8px 35px #1976d24c; color:#fff;}
button, #refreshBtn {
  font-weight: 700;
  box-shadow: 0 5px 18px rgba(33,150,243,0.09);
}
hr { border: none; border-top: 2px solid #e4e9ec; opacity:0.70; margin: 24px 0; }
#refreshBtn {
  margin: 14px auto 8px;
  background: linear-gradient(98deg,var(--status-inprogress),var(--primary) 70%);
  border-radius: 11px;
  font-size: 1.11rem;
  padding: 11px 33px;
  display: block;
  font-weight: 800;
  color: #fff;
  border: none;
  box-shadow: 0 5px 16px #fbc02d33,0 0 7px #fff3, 0 2px 9px #0097a722;
  transition: background 0.19s, box-shadow 0.18s;
}
#refreshBtn:hover { background: linear-gradient(99deg, #efb200 30%, #1976d2 99%);}
.issues-list {
  background: var(--card-bg);
  border-radius: 18px;
  max-width: 720px;
  margin: 4em auto 50px auto;
  padding: 30px 34px;
  box-shadow: var(--shadow);
  font-size: 1.10rem;
  border: 2.2px solid var(--primary);
}
.issues-list .card {
  border-bottom: 2px solid #e3e9ef;
  margin-bottom: 38px;
  padding-bottom: 28px;
  border-radius: 14px;
  box-shadow: 0 2px 17px #1976d211;
  padding-left: 9px;
  padding-right: 9px;
  background: #f7fafd;
  position: relative;
  transition: box-shadow .23s;
}
.issues-list .card:hover { box-shadow:0 8px 38px #1976d210; background:#e3eaf3;}
.issues-list .card:last-child { border-bottom: none; margin-bottom: 0;}
.issues-list .category { color: var(--primary); font-weight: 700; letter-spacing:0.04em; font-size:1.11rem;}
.issues-list .status-tag {
  display: inline-block;
  padding: 4px 13px;
  border-radius: 12px;
  font-weight: 700;
  font-size: 0.93rem;
  margin-left: 16px;
  background: #eee; color: #555;
  text-transform: capitalize;
  vertical-align: middle;
  box-shadow:0 2px 8px #2221;
}
.issues-list .status-tag.reported { background: var(--status-reported);  color: #fff;}
.issues-list .status-tag.acknowledged {background: var(--status-acknowledged); color: #fff;}
.issues-list .status-tag.in_progress {background: var(--status-inprogress); color: #fff;}
.issues-list .status-tag.resolved {background: var(--status-resolved); color: #fff;}
.issues-list .meta { color: #555c; font-size: 0.89rem; margin:10px 0;}
.issues-list img.issue-photo,
.issues-list video,
.issues-list audio {
  margin-top: 17px;
  max-width: 250px;
  border-radius: var(--radius);
  box-shadow: 0 8px 20px #1976d241;
  display: block;
  transition: box-shadow .22s, transform .22s;
}
.issues-list img.issue-photo:hover { box-shadow: 0 12px 29px #29b6f668; transform: scale(1.04);}
.issues-list .user-info {
  display: flex;
  align-items: center;
  gap: 9px;
  margin-top: 10px;
  margin-bottom: 7px;
}
.issues-list .user-info img {
  width: 35px; height:35px; border-radius:50%; border:2px solid var(--primary-dark);
  box-shadow:0 1px 7px #16385d33;
}
.issues-list .user-info .userName {
  font-size: 0.97rem; font-weight:600; color: #1d3557;
  padding-top:2px;
}
/* Responsive Design */
@media (max-width: 900px) {
  .issues-list, form {
    padding: 9vw 3vw;
    max-width: 99vw;
    border-radius: var(--radius);
  }
}
@media (max-width: 600px) {
  body { padding: 0; }
  .header-hero { padding: 22px 8px 15px 10px; font-size: 1.02rem;}
  form { padding: 17px 8vw; }
  .issues-list { padding: 13px 2vw; }
}
</style>
</head>
<body>
<!-- Header/Hero Bar with Branding -->
<div class="header-hero">
  <span class="material-icons" style="background:#fff2;color:var(--primary-dark);">location_city</span>
  <div class="header-hero-content">
    <h1>Smart Civic Issue Reporting</h1>
    <h2>Empowering Citizens â¬© Cleaner, Safer Cities â¬© Digital Social Change</h2>
  </div>
</div>

<!-- Google Login Bar -->
<div id="googleAuthBar">
  <div id="userBar">
    <img id="userAvatar" src="" alt="Avatar">
    <span id="userName"></span>
    <button id="logoutBtn">Logout</button>
  </div>
  <button id="loginBtn">Sign in with Google</button>
</div>

<!-- === Report Form === -->
<form id="issueForm" autocomplete="off">
  <label>Category:
    <select name="category" required>
      <option value="pothole">Pothole</option>
      <option value="streetlight">Streetlight</option>
      <option value="garbage">Garbage</option>
      <option value="water">Water</option>
      <option value="others">Others</option>
    </select>
  </label>
  <label>Description:
    <textarea name="description" rows="3" required placeholder="Describe the civic issue..."></textarea>
  </label>
  <div style="display:flex; gap:11px;">
    <label style="flex:1">Latitude:
      <input type="number" step="any" name="latitude" required />
    </label>
    <label style="flex:1">Longitude:
      <input type="number" step="any" name="longitude" required />
    </label>
    <button style="margin-top:auto; height:38px; align-self:end; background:var(--accent); border-radius:10px; color:#fff; font-weight:700;" type="button" id="locateBtn"><span class="material-icons" style="font-size:18px;vertical-align:middle;">my_location</span></button>
  </div>
  <hr />
  <label>Photo:
    <input type="file" accept="image/*" capture="environment" name="photo" style="margin-bottom:3px;" />
  </label>
  <video id="photoVideo" autoplay muted playsinline style="display:none;"></video>
  <div style="display:flex;gap:.6em;">
    <button type="button" id="startCameraBtn">Start Camera</button>
    <button type="button" id="capturePhotoBtn" style="display:none;">Capture Photo</button>
  </div>
  <canvas id="canvas" style="display:none;"></canvas>
  <hr />
  <label>Video:
    <input type="file" accept="video/*" capture="environment" name="videoFile" style="margin-bottom:3px;" />
  </label>
  <video id="videoRecording" controls style="display:none; margin-top:10px;"></video>
  <div style="display:flex;gap:.6em;">
    <button type="button" id="startVideoBtn">Start Video Recording</button>
    <button type="button" id="stopVideoBtn" disabled>Stop Video Recording</button>
  </div>
  <hr />
  <label>Voice Recording:</label>
  <div style="display:flex;gap:.6em;">
    <button type="button" id="startVoiceBtn">Start Recording</button>
    <button type="button" id="stopVoiceBtn" disabled>Stop Recording</button>
  </div>
  <audio id="audioPlayback" controls style="display:none;"></audio>
  <hr />
  <button type="submit"><span class="material-icons" style="vertical-align:middle;margin-right:8px;">send</span>Report Issue</button>
</form>

<h2 style="margin-bottom:0;border-bottom:3px solid #1976d2;width:fit-content;padding-bottom:10px;margin-left:auto;margin-right:auto;border-radius:7px;">Reported Issues</h2>
<button id="refreshBtn"><span class="material-icons" style="vertical-align:middle;margin-right:9px;">refresh</span>Refresh List</button>
<div class="issues-list" id="issuesList"></div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script>
// ===== Google Login Logic =====
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const userBar = document.getElementById('userBar');
const userAvatar = document.getElementById('userAvatar');
const userNameSpan = document.getElementById('userName');
let googleUser = null;
loginBtn.onclick = () => {
  fetch('/auth/google/login').then(res => res.json()).then(data => {
    window.location.href = data.auth_url;
  });
};
function tryRestoreGoogleUser() {
  if (window.location.pathname === "/auth/google/callback" && window.location.search.includes("code=")) {
    fetch('/auth/google/callback' + window.location.search)
      .then(res => res.json())
      .then(user => {
        googleUser = user;
        showUserBar(user);
        window.history.replaceState({}, document.title, "/");
      });
  }
}
function showUserBar(user) {
  userBar.style.display = 'flex';
  loginBtn.style.display = 'none';
  userAvatar.src = user.picture;
  userNameSpan.textContent = user.name || user.email || "User";
}
logoutBtn.onclick = () => {
  googleUser = null;
  userBar.style.display = 'none';
  loginBtn.style.display = 'inline-block';
};
tryRestoreGoogleUser();

// ========== GEOLOCATION & FORM JS ==========
// Find geolocation
const form = document.getElementById('issueForm');
const issuesList = document.getElementById('issuesList');
const latitudeInput = form.elements['latitude'];
const longitudeInput = form.elements['longitude'];
document.getElementById('locateBtn').onclick = () => {
  if (!navigator.geolocation) {
    alert('Geolocation not supported by your browser.');
    return;
  }
  navigator.geolocation.getCurrentPosition(position => {
    latitudeInput.value = position.coords.latitude.toFixed(6);
    longitudeInput.value = position.coords.longitude.toFixed(6);
  }, () => alert('Unable to retrieve your location.'));
};

// Photo and Video Recording logic...
let cameraStream = null, capturedPhotoBlob = null;
const photoVideo = document.getElementById('photoVideo');
const startCameraBtn = document.getElementById('startCameraBtn');
const capturePhotoBtn = document.getElementById('capturePhotoBtn');
const canvas = document.getElementById('canvas');
startCameraBtn.onclick = async () => {
  try {
    cameraStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }});
    photoVideo.srcObject = cameraStream;
    photoVideo.style.display = 'block';
    capturePhotoBtn.style.display = 'inline-block';
    startCameraBtn.style.display = 'none';
  } catch(e) {
    alert('Could not access camera.');
  }
};
capturePhotoBtn.onclick = () => {
  canvas.width = photoVideo.videoWidth;
  canvas.height = photoVideo.videoHeight;
  canvas.getContext('2d').drawImage(photoVideo, 0, 0);
  canvas.toBlob(blob => {
    capturedPhotoBlob = blob;
    alert('Photo captured! You can now submit the form.');
  }, "image/jpeg");
  photoVideo.style.display = 'none';
  capturePhotoBtn.style.display = 'none';
  if (cameraStream) {
    cameraStream.getTracks().forEach(track => track.stop());
    cameraStream = null;
  }
  startCameraBtn.style.display = 'inline-block';
};

// Video recording
let videoStream = null, mediaRecorderVideo = null, recordedVideoChunks = [], recordedVideoBlob = null;
const startVideoBtn = document.getElementById('startVideoBtn');
const stopVideoBtn = document.getElementById('stopVideoBtn');
const videoRecording = document.getElementById('videoRecording');
startVideoBtn.onclick = async () => {
  try {
    videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    mediaRecorderVideo = new MediaRecorder(videoStream);
    recordedVideoChunks = [];
    mediaRecorderVideo.ondataavailable = e => {
      if (e.data.size > 0) recordedVideoChunks.push(e.data);
    };
    mediaRecorderVideo.onstop = () => {
      recordedVideoBlob = new Blob(recordedVideoChunks, { type: 'video/webm' });
      videoRecording.src = URL.createObjectURL(recordedVideoBlob);
      videoRecording.style.display = 'block';
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
    };
    mediaRecorderVideo.start();
    startVideoBtn.disabled = true;
    stopVideoBtn.disabled = false;
  } catch(e) {
    alert('Could not start video recording.');
  }
};
stopVideoBtn.onclick = () => {
  if (mediaRecorderVideo && mediaRecorderVideo.state === 'recording') {
    mediaRecorderVideo.stop();
    startVideoBtn.disabled = false;
    stopVideoBtn.disabled = true;
  }
};

// Voice recording
const startVoiceBtn = document.getElementById('startVoiceBtn');
const stopVoiceBtn = document.getElementById('stopVoiceBtn');
const audioPlayback = document.getElementById('audioPlayback');
let mediaRecorderAudio, audioChunks = [], recordedAudioBlob = null;
startVoiceBtn.onclick = async () => {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    alert('Audio recording not supported in your browser.');
    return;
  }
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    mediaRecorderAudio = new MediaRecorder(stream);
    audioChunks = [];
    mediaRecorderAudio.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorderAudio.onstop = () => {
      recordedAudioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      audioPlayback.src = URL.createObjectURL(recordedAudioBlob);
      audioPlayback.style.display = 'block';
    };
    mediaRecorderAudio.start();
    startVoiceBtn.disabled = true;
    stopVoiceBtn.disabled = false;
  } catch(e) {
    alert('Could not start audio recording.');
  }
};
stopVoiceBtn.onclick = () => {
  if (mediaRecorderAudio && mediaRecorderAudio.state === 'recording') {
    mediaRecorderAudio.stop();
    startVoiceBtn.disabled = false;
    stopVoiceBtn.disabled = true;
  }
};

// FORM SUBMIT -- includes Google user info if present!
form.onsubmit = async (e) => {
  e.preventDefault();
  const formData = new FormData();
  formData.append('category', form.elements['category'].value);
  formData.append('description', form.elements['description'].value);
  formData.append('latitude', form.elements['latitude'].value);
  formData.append('longitude', form.elements['longitude'].value);
  if (capturedPhotoBlob) {
    formData.append('photo', capturedPhotoBlob, 'captured_photo.jpg');
  } else if (form.elements['photo'].files.length > 0) {
    formData.append('photo', form.elements['photo'].files[0]);
  }
  if (recordedAudioBlob) {
    formData.append('audio', recordedAudioBlob, 'recording.webm');
  }
  if (recordedVideoBlob) {
    formData.append('video', recordedVideoBlob, 'recorded_video.webm');
  } else if (form.elements['videoFile'].files.length > 0) {
    formData.append('video', form.elements['videoFile'].files[0]);
  }
  // Attach Google user info if logged in
  if (googleUser) {
    formData.append('user_name', googleUser.name || '');
    formData.append('user_email', googleUser.email || '');
    formData.append('user_avatar', googleUser.picture || '');
  }
  try {
    const res = await fetch('/issues', {
      method: 'POST',
      body: formData,
    });
    if (!res.ok) {
      alert('Failed to report issue.');
      return;
    }
    alert('Issue reported successfully!');
    form.reset();
    capturedPhotoBlob = null;
    recordedAudioBlob = null;
    recordedVideoBlob = null;
    audioPlayback.style.display = 'none';
    videoRecording.style.display = 'none';
    loadIssues();
  } catch {
    alert('Error submitting form.');
  }
};

// ISSUE LIST RENDERING
async function loadIssues() {
  const res = await fetch('/issues');
  const issues = await res.json();
  if (!issues.length) {
    issuesList.innerHTML = '<p style="text-align:center;color:#555;font-size:1.09em;">No issues reported yet.</p>';
    return;
  }
  issuesList.innerHTML = issues.map(issue => `
    <div class="card">
      <div class="category">${issue.category}
        <span class="status-tag ${issue.status.replace('_', '')}">${issue.status.replace('_',' ')}</span>
      </div>
      <div class="meta">ðŸ•‘ <strong>Created:</strong> ${new Date(issue.created_at).toLocaleString()}</div>
      <div style="margin-bottom:6px;word-break:break-word;">
        <span style="font-weight:500;">${issue.description}</span>
      </div>
      <div class="meta"><i class="material-icons" style="font-size:16px;vertical-align:middle;">place</i>
        <span style="color:#1b3d6b"><b>${Number(issue.latitude).toFixed(6)}, ${Number(issue.longitude).toFixed(6)}</b></span>
      </div>
      ${(issue.user_avatar || issue.user_name || issue.user_email) ? `
        <div class="user-info">
          ${issue.user_avatar ? `<img src="${issue.user_avatar}" alt="user"/>` : ''}
          <span class="userName">${issue.user_name || issue.user_email || "Anon User"}</span>
        </div>
      ` : ''}
      ${issue.photo_url ? `<img class="issue-photo" src="${issue.photo_url}" alt="Photo" />` : ''}
      ${issue.audio_url ? `<audio controls src="${issue.audio_url}"></audio>` : ''}
      ${issue.video_url ? `<video controls src="${issue.video_url}"></video>` : ''}
      <div class="meta"><b>Updated:</b> ${new Date(issue.updated_at).toLocaleString()}</div>
    </div>
  `).join('');
}
document.getElementById('refreshBtn').onclick = loadIssues;
loadIssues();
</script>
</body>
</html>
